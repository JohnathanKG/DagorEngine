Root    ?= ../../../../.. ;
Location = . ;
SrcDir = prog/1stPartyLibs/daScript/utils/daScript ;
ConsoleExe = yes ;

TargetType  = exe ;
Target      = 3rdPartyLibs/scripts/das ;
TargetCodeName = _aot ;
OutDir      = $(Root)/tools/util ;
DasAotCompilerBuild = yes ;
UseQuirrel = sq3r ;
PhysName  ?= Jolt ;
UseD3DMulti       ?= yes ;
UseD3DMultiList   ?= null ;
UseD3DMultiForced ?= windows ;
CheckedContainers ?= yes ;
Exceptions        ?= no ;
if $(UseWholeOpt) != yes { UseLLDLink ?= yes ; } 
daScript_ConsoleExe ?= yes ;
daScript_MaxFunctionArgs ?= 64 ;

include $(Root)/prog/_jBuild/defaults.jam ;

if $(Platform)-$(PlatformArch) = windows-x86_64 { Target = $(Target)-64 ; }
rule AddDasToStringify # folder : files_list
{
  for s in $(2) { DasToStringify += $(1)/$(s).das $(1)/$(s).das.inl $(1)/$(s).cpp ; }
}
Sources =
  prog/1stPartyLibs/daScript/utils/daScript/main.cpp
  prog/1stPartyLibs/daScript/dagorAdapter/da.cpp  
  prog/daNetGame/dasModules/actor.cpp
  prog/daNetGame/dasModules/app.cpp
  prog/daNetGame/dasModules/auth.cpp
  prog/daNetGame/dasModules/camera.cpp
  prog/daNetGame/dasModules/cameraShaker.cpp
  prog/daNetGame/dasModules/capsuleApproximation.cpp
  prog/daNetGame/dasModules/collisionTraces.cpp
  prog/daNetGame/dasModules/dagorDebug3dSolid.cpp
  prog/daNetGame/dasModules/dgNet.cpp
  prog/daNetGame/dasModules/gameObject.cpp
  prog/daNetGame/dasModules/gridCollision.cpp
  prog/daNetGame/dasModules/level.cpp
  prog/daNetGame/dasModules/netPhys.cpp
  prog/daNetGame/dasModules/propsRegistry.cpp
  prog/daNetGame/dasModules/netPropsRegistry.cpp
  prog/daNetGame/dasModules/netstat.cpp
  prog/daNetGame/dasModules/phys.cpp
  prog/daNetGame/dasModules/player.cpp
  prog/daNetGame/dasModules/replay.cpp
  prog/daNetGame/dasModules/scene.cpp
  prog/daNetGame/dasModules/smokeOccluder.cpp
  prog/daNetGame/dasModules/sound/aotSoundProps.cpp
  prog/daNetGame/dasModules/sound_net/aotSoundNetProps.cpp
  prog/daNetGame/dasModules/streaming.cpp
  prog/daNetGame/dasModules/ui.cpp
  prog/daNetGame/dasModules/dacoll.cpp
  prog/daNetGame/dasModules/matchingTypes.cpp
  prog/daNetGame/input/dasModules/touchInput.cpp
  prog/daNetGame/net/reCreateEntityES.cpp.gen.es.cpp
  prog/daNetGame/render/dasModules/clipmapDecals.cpp
  prog/daNetGame/render/dasModules/daSkies.cpp
  prog/daNetGame/render/dasModules/fx.cpp
  prog/daNetGame/render/dasModules/priorityManagedShadervar.cpp
  prog/daNetGame/render/dasModules/dagorMaterials.cpp
  prog/daNetGame/render/dasModules/worldRenderer.cpp
  prog/daNetGame/render/dasModules/heightmapQueryManager.cpp
  prog/daNetGame/render/dasModules/portalRenderer.cpp
  prog/daNetGame/render/dasModules/renderLibsAllowed.cpp
  prog/daNetGame/render/renderLibsAllowed.cpp
  prog/daNetGame/main/dedicated/dasModules/dngMatching.cpp
  prog/daNetGame-das-aot/stub.cpp
  prog/gameLibs/daRg/dasBinding.cpp
;

include $(Root)/prog/gameLibs/render/daFrameGraph/_aot.jam ;
include $(Root)/prog/gameLibs/render/resourceSlot/_aot.jam ;
include $(Root)/prog/gameLibs/render/outline/_aot.jam ;
include $(Root)/prog/gameLibs/ecs/deferToAct/_aot.jam ;
include $(Root)/prog/gameLibs/rendInst/_aot.jam ;
include $(Root)/prog/gameLibs/daEditorE/_aot.jam ;

if $(Platform) in windows linux macOS && $(Config) != rel {
  Sources +=
    prog/daNetGame/dasModules/websocket/webSocket.cpp
    prog/daNetGame/dasModules/websocket/webSocketServer.cpp
  ;
}

AddDasToStringify prog/daNetGame/dasModules :
  dgNet
  dagorDebug3dSolid
;

AddDasToStringify prog/daNetGame/render/dasModules :
  daSkies
  fx
;

if $(Platform) in windows linux macOS && $(Config) != rel {
  AddDasToStringify prog/daNetGame/dasModules/websocket : webSocket ;
}

UseProgLibs +=
  engine/osApiWrappers
  engine/kernel
  engine/perfMon
  engine/math
  engine/gameRes
  engine/memory/rtlStdMemory
  engine/consoleProc
  engine/drv/drv3d_null
#  engine/memory/rtlOverride
  engine/baseUtil
#  engine/ioSys
  engine/startup
  engine/coreUtil
  engine/sceneRay
  engine/scene
  engine/imgui/stub
  engine/animChar/stub
  3rdPartyLibs/eastl
  1stPartyLibs/rapidJsonUtils
  1stPartyLibs/daScript
  1stPartyLibs/daScript/utils/dasFormatter
  1stPartyLibs/daScriptModules/rapidjson
  1stPartyLibs/daScript/modules/dasImgui
  1stPartyLibs/daScript/modules/dasQuirrel
  gameLibs/ecs/game/generic
  gameLibs/ecs/game/zones
  gameLibs/daECS/core
  gameLibs/daECS/gameResStub
  gameLibs/daECS/io/datablock
  gameLibs/daECS/utility
  gameLibs/ecs/scripts/das
  gameLibs/dasModules/common
  gameLibs/dasModules/quirrel
  gameLibs/dasModules/phys
  gameLibs/dasModules/projectiveDecals
  gameLibs/dasModules/ECSGlobalTags
  gameLibs/dasModules/currentCircuit
  gameLibs/dasModules/gameMath
  gameLibs/dasModules/generic
  gameLibs/dasModules/sound
  gameLibs/dasModules/sound/common
  gameLibs/soundSystem/stub
  gameLibs/ecs/sound/stub
  gameLibs/dasModules/shaders
  gameLibs/dasModules/rendInst
  gameLibs/dasModules/daInput
  gameLibs/dasModules/actions
  gameLibs/dasModules/daProfiler
  gameLibs/dasModules/camera
  gameLibs/dasModules/render
  gameLibs/dasModules/stdGui
  gameLibs/dasModules/stdGui/aotStub
  gameLibs/dasModules/imgui
  gameLibs/dasModules/videoPlayer
  gameLibs/dasModules/gpuReadbackQuery
  gameLibs/dasModules/landMesh
  gameLibs/dasModules/systemInfo
  gameLibs/dasModules/compressionUtils
  gameLibs/daGame/timers
  gameLibs/daECS/net
  gameLibs/grid
  gameLibs/jsonUtils
  gameLibs/ecs/scripts/sq
  gameLibs/quirrel/bindQuirrelEx
  gameLibs/quirrel/quirrel_json
  gameLibs/quirrel/sqCrossCall
  gameLibs/spacePartition/looseGrid
  gameLibs/streaming
  gameLibs/dasModules/forceFeedback
  gameLibs/dasModules/net
  gameLibs/dasModules/clientNet
  gameLibs/dasModules/statsd
  gameLibs/daEditorE
  gameLibs/dasModules/daEditor
  gameLibs/propsRegistry
  gameLibs/statsd
  gameLibs/compressionUtils
  gameLibs/landMesh/stub
  gameLibs/gamePhys/collision/stub
  gameLibs/gamePhys/phys/stub
  gameLibs/gamePhys/props/stub
  gameLibs/render/debug3dSolid/stub
;

# warning 6269| Possibly incorrect order of operations: dereference ignored
# warning 6202| Buffer overrun for 'msg.s', which is possibly stack allocated, in call to '_snprintf': length '258' exceeds buffer size '1'
# warning 6386| Buffer overrun: accessing 'argument 1', the writable size is '1' bytes, but '258' bytes might be written
# warning 4312| conversion to a type of greater size on win64
if $(Platform) in windows && $(PlatformSpec) != clang  {
#  CPPopt += /wd6269 /wd6202 /wd6386 /wd4312 ;
}

rule ProcessDasToStringifyTriples
{
  if ! $(1) { return ; }
  StringifySourceFile $(1[1]) : $(1[2]) : $(1[3]) ;
  if $(1[4]) { ProcessDasToStringifyTriples $(1[4-]) ; }
}
ProcessDasToStringifyTriples $(DasToStringify) ;
AddIncludes =
  $(Root)/prog/engine/dagorInclude
  $(Root)/prog/gameLibs/publicInclude
  $(Root)/prog/1stPartyLibs/daScript/include
  $(Root)/prog/daNetGame
  $(Root)/prog/daNetGameLibs
  $(Root)/prog/3rdPartyLibs/rapidjson/include
  $(Root)/prog/gameLibs/publicInclude/quirrel
  $(Root)/prog/1stPartyLibs/quirrel/quirrel/include
  $(Root)/prog/1stPartyLibs/jsoncpp/include
  $(Root)/prog/1stPartyLibs/rapidJsonUtils/include
  $(Root)/prog/3rdPartyLibs/Detour/Include
;
Copt   = $(CPPopt) -O0 ;

include $(Root)/prog/3rdPartyLibs/phys/setup-phys.jam ;
include $(Root)/prog/_jBuild/build.jam ;
